[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Service Work Order",
  "enabled": 0,
  "modified": "2025-11-13 16:12:36.653985",
  "module": "Support",
  "name": "WOandJobLink",
  "script": "frappe.ui.form.on('Service Work Order', {\n\trefresh(frm) {\n\t        frm.dashboard.add_doctype_badge(\"Work Plan\", \"jobwo\");\t// your code here\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Service Work Order",
  "enabled": 1,
  "modified": "2025-11-14 11:48:18.981508",
  "module": "Support",
  "name": "ServiceWOJobList",
  "script": "frappe.ui.form.on('Service Work Order', {\r\n    refresh(frm) {\r\n        if (!frm.is_new()) {\r\n\r\n            // --- Function to Load Jobs ---\r\n            function load_jobs() {\r\n                frappe.call({\r\n                    method: \"frappe.client.get_list\",\r\n                    args: {\r\n                        doctype: \"Work Plan\",\r\n                        fields: [\"name\", \"job_title\", \"job_agent\", \"job_skillcode\", \"sjob_status\"],\r\n                        filters: { jobwo: frm.doc.name },\r\n                        limit_page_length: 50\r\n                    },\r\n                    callback: function(r) {\r\n                        const jobs = r.message || [];\r\n\r\n                        // --- Define status color map ---\r\n                        const status_colors = {\r\n                            \"Draft\": \"badge-secondary\",\r\n                            \"Pending Approval\": \"badge-warning\",\r\n                            \"Submitted\": \"badge-info\",\r\n                            \"Delivered\": \"badge-purple\",\r\n                            \"Approved\": \"badge-success\",\r\n                            \"Signed\": \"badge-primary\",\r\n                            \"Closed\": \"badge-dark\"\r\n                        };\r\n\r\n                        // --- Calculate Progress ---\r\n                        let total_jobs = jobs.length;\r\n                        let closed_jobs = jobs.filter(j => j.sjob_status === \"Closed\").length;\r\n                        let progress_percent = total_jobs ? Math.round((closed_jobs / total_jobs) * 100) : 0;\r\n\r\n                        // --- Choose progress bar color ---\r\n                        let progress_class = \"bg-secondary\";\r\n                        if (progress_percent === 100) progress_class = \"bg-success\";\r\n                        else if (progress_percent >= 70) progress_class = \"bg-info\";\r\n                        else if (progress_percent >= 40) progress_class = \"bg-warning\";\r\n                        else if (progress_percent > 0) progress_class = \"bg-danger\";\r\n\r\n                        // --- Build Job Table ---\r\n                        let rows = \"\";\r\n                        if (jobs.length) {\r\n                            rows = jobs.map(job => {\r\n                                const status = job.sjob_status || \"Draft\";\r\n                                const badge_class = status_colors[status] || \"badge-light\";\r\n                                return `\r\n                                    <tr>\r\n                                        <td><a href=\"/app/service-job/${job.name}\" target=\"_blank\">${job.job_title || job.name}</a></td>\r\n                                        <td>${job.job_agent || \"\"}</td>\r\n                                        <td>${job.job_skillcode || \"\"}</td>\r\n                                        <td><span class=\"badge ${badge_class}\">${status}</span></td>\r\n                                    </tr>\r\n                                `;\r\n                            }).join(\"\");\r\n                        }\r\n\r\n                        // --- Build Final HTML ---\r\n                        frm.fields_dict.jobs_html.$wrapper.html(`\r\n                            <div style=\"margin-top: 10px;\">\r\n                                <div class=\"form-section-heading\" style=\"display: flex; align-items: center; justify-content: space-between;\">\r\n                                    <h6>Jobs</h6>\r\n                                    <div>\r\n                                        <button class=\"btn btn-xs btn-secondary\" id=\"refresh-jobs-btn\" style=\"margin-right: 6px;\">\r\n                                            Refresh Jobs\r\n                                        </button>\r\n                                        <button class=\"btn btn-xs btn-primary\" id=\"new-job-btn\">\r\n                                            New Job\r\n                                        </button>\r\n                                    </div>\r\n                                </div>\r\n\r\n                                <!-- Progress Summary -->\r\n                                <div style=\"margin-top: 10px;\">\r\n                                    <small><b>${closed_jobs}</b> of <b>${total_jobs}</b> Jobs Closed (${progress_percent}%)</small>\r\n                                    <div class=\"progress mt-1\" style=\"height: 8px;\">\r\n                                        <div class=\"progress-bar ${progress_class}\" role=\"progressbar\" \r\n                                            style=\"width: ${progress_percent}%;\" \r\n                                            aria-valuenow=\"${progress_percent}\" aria-valuemin=\"0\" aria-valuemax=\"100\">\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n\r\n                                <!-- Job Table -->\r\n                                ${\r\n                                    jobs.length\r\n                                        ? `<table class=\"table table-bordered table-sm mt-3\">\r\n                                            <thead>\r\n                                                <tr>\r\n                                                    <th>Job</th>\r\n                                                    <th>Agent</th>\r\n                                                    <th>Skill</th>\r\n                                                    <th>Status</th>\r\n                                                </tr>\r\n                                            </thead>\r\n                                            <tbody>${rows}</tbody>\r\n                                        </table>`\r\n                                        : `<p class=\"text-muted mt-2\">No jobs yet for this Work Order.</p>`\r\n                                }\r\n                            </div>\r\n                        `);\r\n\r\n                        // --- Button handlers ---\r\n                        const $wrapper = frm.fields_dict.jobs_html.$wrapper;\r\n                        $wrapper.find('#new-job-btn').on('click', function() {\r\n                            frappe.new_doc('Work Plan', { jobwo: frm.doc.name });\r\n                        });\r\n                        $wrapper.find('#refresh-jobs-btn').on('click', function() {\r\n                            load_jobs(); // Manual refresh\r\n                        });\r\n                    }\r\n                });\r\n            }\r\n\r\n            // --- Initial Load ---\r\n            load_jobs();\r\n\r\n            // --- Auto-Refresh when any Service Job changes ---\r\n            frappe.realtime.on(\"list_update\", (data) => {\r\n                if (data.doctype === \"Service Job\") {\r\n                    load_jobs();\r\n                }\r\n            });\r\n\r\n        } else {\r\n            frm.fields_dict.jobs_html.$wrapper.html(\"<p>Save this Work Order to view related jobs.</p>\");\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 }
]